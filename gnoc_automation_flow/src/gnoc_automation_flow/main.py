#!/usr/bin/env python
from dataclasses import field
from typing import List

from pydantic import BaseModel
from crewai.flow.flow import Flow, listen, start
from .crews.status_page_creation_crew.status_page_creation_crew import  StatusPageCreationCrew
from .types import JiraModel
# from gnoc_automation_flow.src.gnoc_automation_flow.crews.jira_creation_crew.jira_creation_crew import JiraCreationCrew
from .crews.priority_identification_crew.priority_identification_crew import PriorityIdentificationCrew
from .crews.jira_creation_crew.jira_creation_crew import JiraCreationCrew
from .crews.send_google_crew.send_google_crew import GoogleSendCrew
from .crews.google_crew.google_crew import GoogleCrew

class PriorityIdentificationState(BaseModel):
    priority: str = ""
    description: str = ""
    summary: str = ""
    issue_reported: str = ""
    jira_id: str = ""
    subject: str = ""
    # to: list = None
    body: str = ""

class PriorityIdentificationFlow(Flow[PriorityIdentificationState]):

    @start()
    def generate_issue_reported_user(self):
        print("Generating issue reported by user")
        self.state.issue_reported = "As a user I am not able to perform the transaction from the last 15 minutes and due to this over 500K transactions have declined that result in the revenue loss of more than 150K US dollar. Please look into this issue on urgent basis."
        # self.state.issue_reported = "As a user I am not able to perform the transaction from the last 5 minutes and due to this around 100 transactions have declined that result in the revenue loss of around 1000 US dollar. Please look into this issue and provide resolution."

    @listen(generate_issue_reported_user)
    def identify_priority_of_issue(self):
        print("Identifying the priority of the issue reported by user.")
        result = (
            PriorityIdentificationCrew()
            .crew()
            .kickoff(inputs={"issue_reported": self.state.issue_reported})
        )

        # print(f"Priority of the issue:- {result.raw}")
        print(f"Priority:- {result["priority"]}")
        print(f"summary:- {result["summary"]}")
        print(f"Description:- {result["description"]}")
        self.state.priority = result["priority"]
        self.state.description = result["description"]
        self.state.summary= result["summary"]

    @listen(identify_priority_of_issue)
    def save_issue_and_priority(self):
        print("Saving priority")
        with open("priority.txt", "w") as f:
            f.write("Issue reported by user:-\n" + self.state.issue_reported + "\n\nPriority predicted by LLM:- " + self.state.priority + "\n\nDescription generated by LLM:- " + self.state.description)

    @listen(save_issue_and_priority)
    def create_jira_ticket(self):
        print("Create Jira Ticket based on the priority and description generated by LLM.")
        result = (
            JiraCreationCrew()
            .crew()
            .kickoff(inputs={"priority": self.state.priority, "description": self.state.description, "summary": self.state.summary})
        )

        print(f"Jira ticket creation output:- {result.raw}")
        print(f"jiraId:- {result["jira_id"]}")
        print(f"jiraDescription:- {result["description"]}")
        self.state.jira_id = result["jira_id"]
        self.state.priority = result["priority"]
        self.state.description = result["description"]
        self.state.summary = result["summary"]

    @listen(create_jira_ticket)
    def create_status_page_ticket(self):
        print("Create Status Page based on the priority and description generated by LLM.")
        result = (
            StatusPageCreationCrew()
            .crew()
            #.kickoff()
            .kickoff(inputs={"priority": self.state.priority, "description": self.state.description, "jira_id": self.state.jira_id, "summary": self.state.summary})
        )
        print("\n\n################################\n\n")
        print(f"Status Page Creation Output:- {result}")
        print("\n\n################################\n\n")

    @listen(create_status_page_ticket)
    def create_email_template(self):
        print("Creating email template")
        self.state.description = self.state.issue_reported
        result = (
            GoogleCrew()
            .crew()
            .kickoff(inputs={"jira_id": self.state.jira_id, "priority": "High", "description": self.state.description,
                             "project": "GNOC"})
        )

        print("result.raw Email template created", result.raw)
        print("Email subject", result["subject"])
        # print("Email to", result["to"])
        print("Email body", result["body"])
        # self.state.to = result["to"]
        self.state.subject = result["subject"]
        self.state.body = result["body"]

    @listen(create_email_template)
    def send_email_gmail(self):
        print("Send email and calendar invite")
        subject_str = f"{self.state.jira_id} - {self.state.summary}"
        print(f"Email body:- {self.state.body}")
        print(f"Subject email object:- {self.state.jira_id} - {self.state.summary}")
        result = (
            GoogleSendCrew()
            .crew()
            # .kickoff(inputs={"to": to_list, "subject": subject_str, "body": self.state.body})
            .kickoff(inputs={"subject": subject_str, "body": self.state.body})
        )

        print("Email template created", result.raw)
        # self.state.email = result.raw



def kickoff():
    priority_identification_flow = PriorityIdentificationFlow()
    priority_identification_flow.kickoff()


def plot():
    priority_identification_flow = PriorityIdentificationFlow()
    priority_identification_flow.plot()


if __name__ == "__main__":
    kickoff()
